<!DOCTYPE html>
<html>
  <head>
    <title>VTK.js MRI Visualization</title>
    <style>
      body {
        background-color: #000000;
        margin: 0;
        padding: 0;
        height: 100%;
      }
    </style>
    <script type="module">
      import vtkJs from "https://cdn.skypack.dev/vtk.js";
      import "https://cdn.skypack.dev/vtk.js@29.0.0/Sources/favicon";

      import vtkXMLImageDataReader from "https://cdn.skypack.dev/vtk.js@29.0.0/Sources/IO/XML/XMLImageDataReader";

      import vtkActor from "https://cdn.skypack.dev/vtk.js@29.0.0/Sources/Rendering/Core/Actor";

      import vtkFullScreenRenderWindow from "https://cdn.skypack.dev/vtk.js@29.0.0/Sources/Rendering/Misc/FullScreenRenderWindow";

      import vtkVolume from "https://cdn.skypack.dev/vtk.js@29.0.0/Sources/Rendering/Core/Volume";

      import vtkVolumeMapper from "https://cdn.skypack.dev/vtk.js@29.0.0/Sources/Rendering/Core/VolumeMapper";

      import vtkColorTransferFunction from "https://cdn.skypack.dev/vtk.js@29.0.0/Sources/Rendering/Core/ColorTransferFunction";

      import vtkPiecewiseFunction from "https://cdn.skypack.dev/vtk.js@29.0.0/Sources/Common/DataModel/PiecewiseFunction";

      const fullScreenRenderWindow = vtkFullScreenRenderWindow.newInstance({});

      const renderWindow = fullScreenRenderWindow.getRenderWindow();
      const renderer = fullScreenRenderWindow.getRenderer();
      renderWindow.getInteractor().setDesiredUpdateRate(30);

      const reader = vtkXMLImageDataReader.newInstance();

      const actor = vtkVolume.newInstance();
      const mapper = vtkVolumeMapper.newInstance();

      mapper.setSampleDistance(0.7)
      actor.setMapper(mapper)

      // create color and opacity transfer functions
      const ctfun = vtkColorTransferFunction.newInstance();
      ctfun.addRGBPoint(200.0, 0.4, 0.2, 0.0);
      ctfun.addRGBPoint(2000.0, 1.0, 1.0, 1.0);
      const ofun = vtkPiecewiseFunction.newInstance();
      ofun.addPoint(200.0, 0.0);
      ofun.addPoint(1200.0, 0.5);
      ofun.addPoint(3000.0, 0.8);
      actor.getProperty().setRGBTransferFunction(0, ctfun);
      actor.getProperty().setScalarOpacity(0, ofun);
      actor.getProperty().setScalarOpacityUnitDistance(0, 4.5);
      actor.getProperty().setInterpolationTypeToLinear();
      actor.getProperty().setUseGradientOpacity(0, true);
      actor.getProperty().setGradientOpacityMinimumValue(0, 15);
      actor.getProperty().setGradientOpacityMinimumOpacity(0, 0.0);
      actor.getProperty().setGradientOpacityMaximumValue(0, 100);
      actor.getProperty().setGradientOpacityMaximumOpacity(0, 1.0);
      actor.getProperty().setShade(true);
      actor.getProperty().setAmbient(0.2);
      actor.getProperty().setDiffuse(0.7);
      actor.getProperty().setSpecular(0.3);
      actor.getProperty().setSpecularPower(8.0);
      

      mapper.setInputConnection(reader.getOutputPort());


      reader
        .setUrl(
          "https://raw.githubusercontent.com/gaiborjosue/API_Images/main/data/daniel.vti",
          { loadData: true }
        )

        .then(function () {
          renderer.addVolume(actor)
          renderer.resetCamera();
          renderer.getActiveCamera().zoom(1.5);
          renderer.getActiveCamera().elevation(70);
          renderer.updateLightsGeometryToFollowCamera();
          
          var imageData = reader.getOutputData();

          // Log pixel data
          const dataArray = imageData.getPointData().getScalars();
          const pixelData = dataArray.getData();

          console.log("Volume Dimensions: ", imageData.getDimensions());

          // All
          console.log("Full Volume (flattened): ", pixelData);


          console.log("Full Volume (3D): %c not yet working", "color:red");

          console.log(
            "Voxel Access: ",
            imageData.getPointData().getArrays()[0].getValue(60000)
          );

          console.log(
            "Single Slice Access: %c not yet working",
            "color:red"
          );

          console.log("2D or 3D Subvolume: ", imageData.getPointData().getArrays()[0].getTuples(1, 200));

          // Get range from the flattened array of data
          // console.log("Range: ", imageData.getPointData().getArrays()[0].getTuples(2, 400));

          renderWindow.render();
        });

        window.source = reader;
        window.mapper = mapper;
        window.actor = actor;
        window.ctfun = ctfun;
        window.ofun = ofun;
        window.renderer = renderer;
        window.renderWindow = renderWindow;

    </script>
  </head>
  <body>
  </body>
</html>
