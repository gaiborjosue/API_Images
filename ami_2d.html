<html>

  <head>
    <title>Lesson 03</title>
    <style>
      body {
        background-color: #212121;
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden !important;
      }

      #container {
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        position: absolute;
        z-index: -10;
      }
    </style>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.3/dat.gui.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/87/three.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ami.js/0.0.22/ami.min.js"></script>

  </head>

  <body>
    <div id="my-gui-container"></div>
    <div id="container"></div>

    <script type="text/javascript">
      var stackHelper;
      // Setup renderer
      const container = document.getElementById('container');
      var renderer = new THREE.WebGLRenderer({
        antialias: true,
      });
      renderer.setSize(container.offsetWidth, container.offsetHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);

      const scene = new THREE.Scene();

      const camera = new AMI.OrthographicCamera(
            container.clientWidth / -2,
            container.clientWidth / 2,
            container.clientHeight / 2,
            container.clientHeight / -2,
            0.1,
            10000
          );

      // Setup controls
      const controls = new AMI.TrackballOrthoControl(camera, container);
      controls.staticMoving = true;
      controls.noRotate = true;
      camera.controls = controls;

      const onWindowResize = () => {
        camera.canvas = {
          width: container.offsetWidth,
          height: container.offsetHeight,
        };
        camera.fitBox(2);

        renderer.setSize(container.offsetWidth, container.offsetHeight);
      };
      window.addEventListener('resize', onWindowResize, false);

      var file = "https://haehn.github.io/VIZBI/daniel.nii";
      const loader = new AMI.VolumeLoader(container);
      loader
        .load(file)
        .then(() => {
          const series = loader.data[0].mergeSeries(loader.data);
          const stack = series[0].stack[0];
          loader.free();

          stackHelper = new AMI.StackHelper(stack);
          stackHelper.bbox.visible = false;
          scene.add(stackHelper);
          gui(stackHelper);

          // center camera and interactor to center of bouding box
          // for nicer experience
          // set camera
          const worldbb = stack.worldBoundingBox();
          const lpsDims = new THREE.Vector3(
            worldbb[1] - worldbb[0],
            worldbb[3] - worldbb[2],
            worldbb[5] - worldbb[4]
          );

          const box = {
            center: stack.worldCenter().clone(),
            halfDimensions: new THREE.Vector3(lpsDims.x + 10, lpsDims.y + 10, lpsDims.z + 10),
          };

          // init and zoom
          const canvas = {
            width: container.clientWidth,
            height: container.clientHeight,
          };

          camera.directions = [stack.xCosine, stack.yCosine, stack.zCosine];
          camera.box = box;
          camera.canvas = canvas;
          camera.update();
          camera.fitBox(2);

          console.log("Volume Dimensions: ", [loader.data[0].stack[0].dimensionsIJK.x, loader.data[0].stack[0].dimensionsIJK.y, loader.data[0].stack[0].dimensionsIJK.z])

          console.log("Full Volume (flattened): ", loader.data[0].stack[0].frame[0].pixelData);

          console.log("XYZ Voxel Access: ", loader.data[0].stack[0].frame[0].getPixelData(100, 100));
          
          console.log("Slice Access: ", loader.data[0].stack[0].frame.at(stackHelper.index).pixelData);
        })
        .catch(error => {
          window.console.log('oops... something went wrong...');
          window.console.log(error);
        });

      const animate = () => {
        controls.update();
        renderer.render(scene, camera);

        requestAnimationFrame(function() {
          animate();
        });
      };

      animate();

      const gui = stackHelper => {
        const gui = new dat.GUI({
          autoPlace: false,
        });

        const customContainer = document.getElementById('my-gui-container');
        customContainer.appendChild(gui.domElement);
        const camUtils = {
          invertRows: false,
          invertColumns: false,
          rotate45: false,
          rotate: 0,
          orientation: 'default',
          convention: 'radio',
        };

        // camera
        const cameraFolder = gui.addFolder('Camera');
        const invertRows = cameraFolder.add(camUtils, 'invertRows');
        invertRows.onChange(() => {
          camera.invertRows();
        });

        const invertColumns = cameraFolder.add(camUtils, 'invertColumns');
        invertColumns.onChange(() => {
          camera.invertColumns();
        });

        const rotate45 = cameraFolder.add(camUtils, 'rotate45');
        rotate45.onChange(() => {
          camera.rotate();
        });

        cameraFolder
          .add(camera, 'angle', 0, 360)
          .step(1)
          .listen();

        const orientationUpdate = cameraFolder.add(camUtils, 'orientation', [
          'default',
          'axial',
          'coronal',
          'sagittal',
        ]);
        orientationUpdate.onChange(value => {
          camera.orientation = value;
          camera.update();
          camera.fitBox(2);
          stackHelper.orientation = camera.stackOrientation;
        });

        const conventionUpdate = cameraFolder.add(camUtils, 'convention', ['radio', 'neuro']);
        conventionUpdate.onChange(value => {
          camera.convention = value;
          camera.update();
          camera.fitBox(2);
        });

        cameraFolder.open();

        const stackFolder = gui.addFolder('Stack');
        stackFolder
          .add(stackHelper, 'index', 0, stackHelper.stack.dimensionsIJK.z - 1)
          .step(1)
          .listen();
        stackFolder
          .add(stackHelper.slice, 'interpolation', 0, 1)
          .step(1)
          .listen();
        stackFolder.open();
      };

    </script>

  </body>

</html>
